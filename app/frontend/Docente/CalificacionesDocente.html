<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAIIUT Dashboard</title>

    <!-- Tailwind y fuentes -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet" />

    <!-- Font Awesome para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Auth Guard -->
    <script src="../js/auth-guard.js"></script>

    <style>
      body {
        font-family: 'IBM Plex Sans', sans-serif;
        background: linear-gradient(135deg, #ffffff 0%, #f0f4f3 100%);
      }
      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
    </style>
  </head>

  <body class="text-[#2D3E34] flex flex-col min-h-screen">
    <div class="flex flex-1">
      <!-- Sidebar -->
      <aside class="hidden md:flex w-64 bg-[#2D3E34] text-white flex-col justify-between p-6 shadow-xl">
        <div>
          <div class="mb-12 text-center">
            <img src="../images/logo.png" alt="Mi logo" class="mx-auto w-full max-w-[200px]" />
          </div>
          <nav class="space-y-4">
            <a href="IndexDocente.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-[#1b2b23] transition-all duration-300">
              <i class="fas fa-home w-5 h-5 text-white"></i>
              <span class="font-medium">Inicio</span>
            </a>
            <a href="CalificacionesDocente.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-[#1b2b23] transition-all duration-300">
              <i class="fas fa-chart-line w-5 h-5 text-white"></i>
              <span class="font-medium">Calificaciones</span>
            </a>
            <a href="TutoriasDocente.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-[#1b2b23] transition-all duration-300">
              <i class="fas fa-chalkboard-teacher w-5 h-5 text-white"></i>
              <span class="font-medium">Tutorías</span>
            </a>
            <a href="ConfiguracionDocente.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-[#1b2b23] transition-all duration-300">
              <i class="fas fa-cog w-5 h-5 text-white"></i>
              <span class="font-medium">Configuración</span>
            </a>
          </nav>
        </div>
      </aside>

      <!-- Contenido principal -->
      <main class="flex-1 p-6 md:p-10 flex flex-col">
        <!-- Encabezado -->
        <div class="mb-6">
          <div class="flex justify-between items-center flex-wrap gap-4">
            <h2 class="text-3xl font-bold">Asignar calificaciones</h2> 
            <div class="flex gap-6 text-3xl cursor-pointer">
              <i class="fas fa-bell hover:text-[#F4A300] transition"></i>
              <i class="fas fa-user hover:text-[#F4A300] transition"></i>
            </div>
          </div>
          <hr class="mt-4 border-[#D1D5DB]" />
        </div>
        <!-- Contenido principal -->
        <div class="flex flex-col items-center w-full pt-10">
          <div class="w-full max-w-lg mx-auto bg-white rounded-xl shadow-lg border border-gray-200 p-8 flex flex-col gap-6">
            <h3 class="text-xl font-semibold text-center text-gray-800">Seleccionar Grupo</h3>
            
            <div class="flex flex-col gap-2">
              <label for="materias-select" class="font-medium text-gray-700">1. Selecciona una materia:</label>
              <select id="materias-select" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <option value="">Cargando materias...</option>
              </select>
            </div>

            <div class="flex flex-col gap-2">
              <label for="grupos-select" class="font-medium text-gray-700">2. Selecciona un grupo:</label>
              <select id="grupos-select" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" disabled>
                <option value="">Selecciona una materia primero</option>
              </select>
            </div>

            <div class="flex justify-center mt-4">
              <button id="btn-administrar" class="bg-gray-400 text-white py-2 px-6 rounded-md transition duration-200 focus:outline-none cursor-not-allowed" disabled>
                Administrar Calificaciones
              </button>
            </div>
          </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const userData = JSON.parse(sessionStorage.getItem('userData'));
            if (!userData || !userData.id_profesor) {
                console.error("No se encontró el ID del profesor en la sesión.");
                alert("Error de autenticación. No se pudo identificar al profesor.");
                return;
            }
            const profesorId = userData.id_profesor;

            const materiasSelect = document.getElementById('materias-select');
            const gruposSelect = document.getElementById('grupos-select');
            const adminButton = document.getElementById('btn-administrar');

            // --- Carga inicial de materias ---
            async function cargarMaterias() {
                try {
                    const res = await fetch(`http://localhost:5000/api/profesores/${profesorId}/materias`, { credentials: 'include' });
                    if (!res.ok) throw new Error('Error al obtener las materias del profesor.');
                    
                    const materias = await res.json();
                    materiasSelect.innerHTML = '<option value="">Selecciona una materia</option>';
                    materias.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id_materia;
                        option.textContent = m.nombre_materia;
                        materiasSelect.appendChild(option);
                    });
                } catch (e) {
                    console.error(e);
                    materiasSelect.innerHTML = '<option value="">Error al cargar materias</option>';
                }
            }

            // --- Carga de grupos cuando se selecciona una materia ---
            async function cargarGruposPorMateria(idMateria) {
                gruposSelect.disabled = true;
                gruposSelect.innerHTML = '<option value="">Cargando grupos...</option>';
                adminButton.disabled = true;
                adminButton.classList.add('bg-gray-400', 'cursor-not-allowed');

                try {
                    // Asumimos que existe un endpoint que devuelve los grupos para un profesor y una materia.
                    // Si no existe, necesitaremos crearlo.
                    const res = await fetch(`http://localhost:5000/api/profesores/${profesorId}/materia/${idMateria}/grupos`, { credentials: 'include' });
                    if (!res.ok) throw new Error('Error al obtener los grupos para la materia seleccionada.');

                    const grupos = await res.json();
                    gruposSelect.innerHTML = '<option value="">Selecciona un grupo</option>';
                    grupos.forEach(g => {
                        const option = document.createElement('option');
                        option.value = g.id_grupo;
                        option.textContent = g.nombre_grupo;
                        gruposSelect.appendChild(option);
                    });
                    gruposSelect.disabled = false;
                } catch (e) {
                    console.error(e);
                    gruposSelect.innerHTML = '<option value="">Error al cargar grupos</option>';
                }
            }

            // --- Event Listeners ---
            materiasSelect.addEventListener('change', () => {
                const idMateria = materiasSelect.value;
                if (idMateria) {
                    cargarGruposPorMateria(idMateria);
                } else {
                    gruposSelect.innerHTML = '<option value="">Selecciona una materia primero</option>';
                    gruposSelect.disabled = true;
                    adminButton.disabled = true;
                    adminButton.classList.add('bg-ray-400', 'cursor-not-allowed');
                }
            });

            gruposSelect.addEventListener('change', () => {
                if (gruposSelect.value) {
                    adminButton.disabled = false;
                    adminButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    adminButton.classList.add('bg-[#2D3E34]', 'hover:bg-[#F4A300]');
                } else {
                    adminButton.disabled = true;
                    adminButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            });

            adminButton.addEventListener('click', () => {
                const idMateria = materiasSelect.value;
                const idGrupo = gruposSelect.value;
                if (idMateria && idGrupo) {
                    window.location.href = `CalificacionesDocente2.html?profesor=${profesorId}&grupo=${idGrupo}&materia=${idMateria}`;
                }
            });

            // --- Carga inicial ---
            cargarMaterias();
          });
        </script>

        <!-- Footer -->
        <footer class="mt-auto border-t pt-6 text-sm flex flex-col md:flex-row justify-between md:items-center items-start text-[#2D3E34] gap-6 px-6 md:px-10 pb-10 bg-white">
          <!-- Conócenos -->
          <div class="flex flex-col items-start w-full md:w-auto">
            <h4 class="font-semibold underline">Conócenos</h4>
            <p>Teléfono: <a href="tel:+52474725300" class="hover:text-[#F4A300]">+52 (247) 47-25-300</a></p>
            <p>Email: <a href="mailto:contacto@uttlaxcala.edu.mx" class="hover:text-[#F4A300]">contacto@uttlaxcala.edu.mx</a></p>
          </div>

          <!-- Síguenos -->
          <div class="flex flex-col items-start md:items-center w-full md:w-auto">
            <h4 class="font-semibold underline mb-2">Síguenos</h4>
            <div class="flex gap-4 text-2xl">
              <a href="https://www.facebook.com/UTTLAXCALA" target="_blank" rel="noopener" class="hover:text-[#F4A300]"><i class="fab fa-facebook-f"></i></a>
              <a href="https://twitter.com/UTTLAXCALA" target="_blank" rel="noopener" class="hover:text-[#F4A300]"><i class="fab fa-twitter"></i></a>
              <a href="https://wa.me/5212474725300" target="_blank" rel="noopener" class="hover:text-[#F4A300]"><i class="fab fa-whatsapp"></i></a>
            </div>
          </div>

          <!-- Ubicación -->
          <div class="flex flex-col items-start md:items-center w-full md:w-auto">
            <h4 class="font-semibold underline mb-2">Ubicación</h4>
            <a href="https://maps.app.goo.gl/RkmhJ141DRooR8HU9" target="_blank" rel="noopener" class="text-3xl hover:text-[#F4A300]">
              <i class="fas fa-map-marker-alt"></i>
              <span class="ml-2 text-base">Ver en Google Maps</span>
            </a>
          </div>
        </footer>
      </main>
    </div>
  </body>
</html>
